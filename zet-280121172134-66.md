---
title: docker
created: 2021-01-28 17:21
tags: :Tech:Application:docker:
Backlinks: [index](index.md)
type: text/x-markdown
---

## 简介

* docker是容器(container),不是虚拟机.虚拟机是 *虚拟机*,即模拟硬件及软件系统,需要更多资源.
* 核心利用[OS-level virtualization](https://en.wikipedia.org/wiki/OS-level_virtualization),即内核允许存在多个独立的用户空间.
  docker是兼容windows、linux、macOS的虚拟技术.类似有 *LCX*,*Solaris containers*等
* docker核心概念`container`, `image`, `context`
* docker 执行[ELF](zet-290121232539-64.md)格式文件. ref [docker from scratch](file:../articles/Docker FROM scratch.pdf)

## 常用指令

* `docker build [-t <IMAGE-NAME>:TAG] (PATH|URL|-)`  
  docker build是 *C/S模式*,命令发送到docker server,*context* 即指明把对应内容打包发到docker server
  *URL* 可以的内容为 *git respository*, *pre-packaged tarbar*, *plain text files*.

* `docker [image] pull `

* `docker container run <IMAGE>`: 通过image创建容器.如果未找到IMAGE,则自动去仓库pull.**run** 每次都会新建容器,区别于 **start**.

* `docker (start|stop|restart) <CONTAINER-ID>`

* `docker kill`: 发送 *SIGKILL* 即强杀进程.stop则是 *SIGTERM* 终止服务后再 *SIGKILL*.

* `docker run [-it] image <CMD>`

* `docker exec <CONTAINER-ID>`

* `docker attach <CONTAINER-ID>` 同`exec`,但attach退出会终止container运行.

* `docker ps [-a]`: 查看容器. `-a`: 包括stoped容器.

* `docker export <CONTAINER-ID> > file.tar` `docker import (<FILE>|<URL>|-) <IMAGE-NAME>[:TAG])`

* 其他: `docker container logs <CONTAINER-ID>`、

## Dockerfile

用来制作镜像的文件

* `FROM base_image`  
  base_image 基础镜像.镜像一般都是从父镜像中.常用的最底层镜像有如下几个
  
  * **scratch**: 最基础的镜像,镜像的最高层.只能用来安装基本镜像.
    使用方法:
    
    ```dockerfile
    FROM scratch
    ADD hello /
    CMD ["/hello"]
    ```
  
  * **hello-world**: 超小的镜像.
  
  * **busybox**: 打包unix常用工具指令(grep、vim等)的镜像.

* `RUN  ["可执行文件", "参数1", "参数2"]` 或 `RUN <commands>`  
  docker build的时候在镜像内执行的命令

* `CMD ["<可执行文件或命令>","<param1>","<param2>",...]`  
  docker run 时运行.
  
  * 会被 **docker run <Commands>** 的commands覆盖.

* `ENTRYPOINT ["<executeable>","<param1>","<param2>",...]`  
  类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。
  
  * 如果配置多条则只有最后一条生效.
  * 区别于 **CMD** 不会被 *docker run* 命令覆盖.
  * 可以通 **run --entrypoint** 选项覆盖.

* `WORKDIR dirctory`  
  指定工作目录。用 WORKDIR 指定的工作目录，会在构建镜像的每一层中都存在。

* `ADD `  
  
  * ADD 的优点：在执行 <源文件> 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 <目标路径>。
  * ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。

* `COPY [--chown=<user>:<group>] ["<源路径1>",...  "<目标路径>"]`  
  从 *上下文* 目录中复制文件或者目录到容器制定路径.
  
  * 官方推荐使用 *COPY* 替代 *ADD*.

* `EXPOSE <端口1> [<端口2>...]`
  声明作用.

* `VOLUME ["<路径1>", "<路径2>"...]`  
  定义匿名数据卷。在启动容器时忘记挂载数据卷，会自动挂载到匿名卷。
  作用：
  
  - 避免重要的数据，因容器重启而丢失，这是非常致命的。
  - 避免容器不断变大。

* `ENV <key1>=<value1> <key2>=<value2>...`  
  设置环境变量.

* `ARG <参数名>[=<默认值>]`  
  build过程中的环境变量.

* `USER <用户名称>[:<用户组>]`  
  su user切换当前用户.

----

ref: [docker file command](https://www.runoob.com/docker/docker-dockerfile.html)
