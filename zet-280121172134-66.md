
---
title: docker
created: 2021-01-28 17:21
tags: :Tech:Application:docker:
Backlinks: [index](index.md)
type: text/x-markdown
---

## 简介

* docker是容器(container),不是虚拟机.虚拟机是 *虚拟机*,即模拟硬件及软件系统,需要更多资源.
* 核心利用[OS-level virtualization](https://en.wikipedia.org/wiki/OS-level_virtualization),即内核允许存在多个独立的用户空间.
  docker 是兼容windows、linux、macOS 的虚拟技术。类似有 *LCX*, *Solaris containers* 等  
  docker 容器格式版本变化: LCX -> [libcontainer](https://github.com/docker/libcontainer) ->   1.1版本后 runC 和 containerd
* docker核心概念`container`, `image`, `context`

## 常用指令
 	* docker 参数形式有两种。 **shell** 和 **exec** 两种。如 `RUN echo $var` 和 `RUN ["echo", "$var"]` ，推荐exec格式（注意双引号）
    * 前台和后台的区别。 docker 需要前台的进程。如果 *CMD nginx -s start* ，启动后会容器会直接退出

* `docker build [-t <IMAGE-NAME>:TAG] (PATH|URL|-)`  
  docker build是 *C/S模式*,命令发送到docker server,*context* 即指明把对应内容打包发到docker server
  *URL* 可以的内容为 *git respository*, *pre-packaged tarbar*, *plain text files*.

* `docker [image] pull `

* `docker [container] run <IMAGE> [CMD] [ARG]`: 通过image创建容器.如果未找到IMAGE,则自动去仓库pull.**run** 每次都会新建容器(区别于 **start**) 。

* `docker (start|stop|restart) <CONTAINER-ID>`

* `docker kill`: 发送 *SIGKILL* 即强杀进程。 *stop* 则是 *SIGTERM* 终止服务后再 *SIGKILL* 。

* `docker exec <CONTAINER-ID>`

* `docker attach <CONTAINER-ID>` 同 exec,但 attach 退出会终止 container 运行。

* `docker ps [-a]`: 查看容器. `-a`: 包括stoped容器.

* `docker export <CONTAINER-ID> > file.tar` `docker import (<FILE>|<URL>|-) <IMAGE-NAME>[:TAG])`

* 其他: `docker container logs <CONTAINER-ID>`、

## Dockerfile

用来制作镜像的文件

* `FROM base_image`  
  base_image 基础镜像.镜像一般都是从父镜像中.常用的最底层镜像有如下几个
  
  * **scratch**: 最基础的镜像,镜像的最高层.只能用来安装基本镜像.
    使用方法:
    
    ```dockerfile
    FROM scratch
    ADD hello /
    CMD ["/hello"]
    ```
  
  * **hello-world**: 超小的镜像.
  
  * **busybox**: 打包unix常用工具指令(grep、vim等)的镜像.

* `RUN  ["可执行文件", "参数1", "参数2"]` 或 `RUN <commands>`  
  docker build的时候在镜像内执行的命令

* `CMD ["<可执行文件或命令>","<param1>","<param2>",...]`  
  docker run 时运行.
  
  * **会被 docker run <Commands> 的 <Commands> 覆盖**

* `ENTRYPOINT ["<executeable>","<param1>","<param2>",...]`  
  类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。
  
  * 如果配置多条则只有最后一条生效.
  * 不会被 *docker run cmd* 命令直接覆盖。需要 **--entrypoint cmd** 选项覆盖.

* `WORKDIR dirctory`  
  指定工作目录。用 WORKDIR 指定的工作目录，会在构建镜像的每一层中都存在。

* `ADD `  
  **❗无法使用绝对路径。即只能发送当前文件夹下文件**
  把本地文件上传到docker image 中
  * ADD 自动解压 `gzip`, `bzip` 等压缩文件
  * <src> 可以是 URL 。

* `COPY [--chown=<user>:<group>] ["<源路径1>",...  "<目标路径>"]`  
  **❗无法使用绝对路径。即只能发送当前文件夹下文件**  
  从 *上下文* 目录中复制文件或者目录到容器制定路径.
  
  **官方推荐使用 COPY 替代 ADD**

* `EXPOSE <端口1> [<端口2>...]`
  声明作用.

* `VOLUME ["<路径1>", "<路径2>"...]`  
  定义匿名数据卷
  **向匿名卷写入的数据不会记录到容器存储层** 。容器运行时尽量保持容器存储层不发生写操作。
  在启动容器时忘记挂载数据卷，会自动挂载到匿名卷。
  `docker run` 命令的 `-v` 参数挂载并且影射本地目录到挂载点。

* `ENV <key1>=<value1> <key2>=<value2>...`  
  设置环境变量。

* `ARG <参数名>[=<默认值>]`  
  build 过程中的环境变量，容器运行时不会存在。

* `USER <用户名称>[:<用户组>]`  
  su user切换当前用户。

----

## references
1. [docker file command](https://www.runoob.com/docker/docker-dockerfile.html)
2. [docker 从入门到实践-gitbook](https://yeasy.gitbook.io/docker_practice/image/dockerfile/volume) 比较全面的从原理简介及使用方法。
3. docker linux OS 执行[ELF](zet-290121232539-64.md)格式文件. 制作镜像执行文件 [docker from scratch](file:../articles/tech/Docker FROM scratch.pdf)
